import{j as l,B as j,ag as H,I as U,F as $,L as F,S as G,M as L}from"./mui-vendor-Bb0AjAZd.js";import{r as x}from"./react-vendor-QLNaZ7XN.js";import{b as O,l as _,s as z}from"./index-BsZOdJxP.js";import"./motion-vendor-Bslre2pU.js";function N({id:a,x:M,y:Y,w:R,h:m,editing:u,onRemove:p,dragStart:W,dragMove:s,dragEnd:b,resizeStart:D,resizeMove:v,resizeEnd:S,children:h,bare:C=!1,margin:I=8,padding:B=1,center:T=!0}){const X=I,E=C?j:H,k=C?{position:"absolute",left:M,top:Y,width:R,height:m,userSelect:"none",touchAction:"none"}:{position:"absolute",left:M,top:Y,width:R-X*2,height:m-X*2,m:`${X}px`,userSelect:"none",touchAction:"none"};return l.jsxs(E,{sx:k,onPointerDown:u?g=>W(a,g):void 0,onPointerMove:u?s:void 0,onPointerUp:u?b:void 0,onPointerCancel:u?b:void 0,children:[u&&l.jsx(U,{size:"small",sx:{color:"inherit",position:"absolute",right:0,top:0,zIndex:1},onPointerDown:g=>g.stopPropagation(),onClick:g=>{g.stopPropagation(),p(a)},children:l.jsx(O,{fontSize:"small"})}),C?h:l.jsx(j,{sx:{width:"100%",height:"100%",p:B,boxSizing:"border-box",...T?{display:"flex",alignItems:"center",justifyContent:"center"}:{}},children:h}),u&&l.jsx(j,{sx:{position:"absolute",bottom:0,right:0,width:16,height:16,cursor:"nwse-resize",touchAction:"none"},onPointerDown:g=>{g.stopPropagation(),D(a,g)},onPointerMove:v,onPointerUp:S,onPointerCancel:S})]})}function Q({dashboardId:a,editing:M,onExitEdit:Y,teams:R}){const[m,u]=x.useState([]),p=x.useRef([]),W=x.useMemo(()=>[...R].sort((t,e)=>(t.order??0)-(e.order??0)),[R]);x.useEffect(()=>{_(a).then(t=>u(t.map(e=>{const{dashboardId:n,...r}=e;return r})))},[a]),x.useEffect(()=>{p.current=m},[m]);const s=x.useRef(null),[b,D]=x.useState({width:0,height:0}),[v,S]=x.useState(null),[h,C]=x.useState(null);x.useEffect(()=>{if(!s.current)return;const t=new ResizeObserver(e=>{const n=e[0].contentRect;D({width:n.width,height:n.height})});return t.observe(s.current),()=>t.disconnect()},[]);const I=(t,e,n)=>{if(t==="target-select"&&p.current.some(d=>d.type==="target-select")||!s.current)return;const r=s.current.getBoundingClientRect(),o=r.width/4,i=r.height/8,c=Math.max(0,Math.min(3,Math.round(e/o))),w=Math.max(0,Math.min(7,Math.round(n/i))),P={id:crypto.randomUUID(),type:t,title:"",x:c,y:w,w:1,h:1},f=[...p.current,P];u(f),z(a,f.map(d=>({...d,dashboardId:a})))},B=(t,e)=>{var c,w;const n=m.find(P=>P.id===t);if(!n||!s.current)return;(w=(c=e.currentTarget).setPointerCapture)==null||w.call(c,e.pointerId);const r=s.current.getBoundingClientRect(),o=r.width/4,i=r.height/8;S({id:t,offsetX:(e.clientX-r.left)/o-n.x,offsetY:(e.clientY-r.top)/i-n.y})},T=t=>{if(!v||!s.current)return;const e=s.current.getBoundingClientRect(),n=e.width/4,r=e.height/8;let o=(t.clientX-e.left)/n-v.offsetX,i=(t.clientY-e.top)/r-v.offsetY;o=Math.round(o),i=Math.round(i);const c=p.current.find(f=>f.id===v.id),w=c?4-c.w:3,P=c?8-c.h:7;o=Math.max(0,Math.min(w,o)),i=Math.max(0,Math.min(P,i)),u(f=>f.map(d=>d.id===v.id?{...d,x:o,y:i}:d))},X=t=>{var e,n;(n=(e=t.currentTarget).releasePointerCapture)==null||n.call(e,t.pointerId),S(null),z(a,p.current.map(r=>({...r,dashboardId:a})))},E=(t,e)=>{var r,o;const n=m.find(i=>i.id===t);n&&((o=(r=e.currentTarget).setPointerCapture)==null||o.call(r,e.pointerId),C({id:t,startW:n.w,startH:n.h,startX:e.clientX,startY:e.clientY}))},k=t=>{if(!h||!s.current)return;const e=s.current.getBoundingClientRect(),n=e.width/4,r=e.height/8;let o=h.startW+(t.clientX-h.startX)/n,i=h.startH+(t.clientY-h.startY)/r;o=Math.round(o),i=Math.round(i);const c=p.current.find(f=>f.id===h.id),w=c?4-c.x:4,P=c?8-c.y:8;o=Math.max(1,Math.min(w,o)),i=Math.max(1,Math.min(P,i)),u(f=>f.map(d=>d.id===h.id?{...d,w:o,h:i}:d))},g=t=>{var e,n;(n=(e=t.currentTarget).releasePointerCapture)==null||n.call(e,t.pointerId),C(null),z(a,p.current.map(r=>({...r,dashboardId:a})))},A=t=>{const e=p.current.filter(n=>n.id!==t);u(e),z(a,e.map(n=>({...n,dashboardId:a})))},y=m.some(t=>t.type==="target-select");return l.jsxs(j,{sx:{display:"flex",p:2,position:"relative",maxWidth:1024,width:"100%",mx:"auto"},children:[l.jsx(j,{ref:s,sx:{position:"relative",flexGrow:1,minHeight:512,backgroundImage:"linear-gradient(#e0e0e0 1px, transparent 1px), linear-gradient(90deg, #e0e0e0 1px, transparent 1px)",backgroundSize:"25% 12.5%"},onClick:t=>{M&&t.target===t.currentTarget&&Y()},onDragOver:t=>{M&&t.preventDefault()},onDrop:t=>{var n,r;if(!M)return;const e=t.dataTransfer.getData("text/plain");I(e,t.clientX-(((n=s.current)==null?void 0:n.getBoundingClientRect().left)??0),t.clientY-(((r=s.current)==null?void 0:r.getBoundingClientRect().top)??0))},children:m.map(t=>{const e=b.width/4,n=b.height/8;return l.jsx(N,{id:t.id,x:t.x*e,y:t.y*n,w:t.w*e,h:t.h*n,editing:M,onRemove:A,dragStart:B,dragMove:T,dragEnd:X,resizeStart:E,resizeMove:k,resizeEnd:g,padding:t.type==="target-select"?0:void 0,children:t.type==="target-select"&&l.jsxs($,{fullWidth:!0,children:[l.jsx(F,{id:`${t.id}-label`,children:"分析対象"}),l.jsx(G,{labelId:`${t.id}-label`,label:"分析対象",defaultValue:"",onPointerDown:r=>r.stopPropagation(),children:W.map(r=>l.jsx(L,{value:r.id,children:r.name},r.id))})]})},t.id)})}),M&&l.jsx(j,{sx:{width:"20%",pl:2,boxSizing:"border-box"},children:l.jsx(j,{draggable:!y,onDragStart:t=>{y||t.dataTransfer.setData("text/plain","target-select")},sx:{border:"1px solid",borderRadius:1,p:1,cursor:y?"not-allowed":"grab",opacity:y?.5:1},children:"分析対象ウィジェット"})})]})}export{Q as default};
